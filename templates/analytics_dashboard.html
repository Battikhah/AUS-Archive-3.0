{% extends "layout.html" %} {% block title %}Admin Analytics Dashboard{% endblock %} {% block additional_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
	.analytics-container {
		max-width: 1200px;
		margin: 0 auto;
	}
	.stats-card {
		background-color: #fff;
		border-radius: 8px;
		padding: 20px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		margin-bottom: 20px;
	}
	.stats-header {
		display: flex;
		justify-content: space-between;
		margin-bottom: 15px;
		align-items: center;
	}
	.stats-header h3 {
		margin: 0;
		color: #333;
	}
	.stats-value {
		font-size: 2rem;
		font-weight: bold;
		color: #007bff;
	}
	.stats-label {
		color: #666;
		font-size: 0.9rem;
	}
	.chart-container {
		height: 300px;
		margin-bottom: 30px;
	}
	.card-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 20px;
		margin-bottom: 30px;
	}
	.table-container {
		overflow-x: auto;
	}
	.analytics-table {
		width: 100%;
		border-collapse: collapse;
	}
	.analytics-table th,
	.analytics-table td {
		padding: 10px;
		text-align: left;
		border-bottom: 1px solid #ddd;
	}
	.analytics-table th {
		background-color: #f5f5f5;
	}
	.refresh-button {
		padding: 8px 15px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
	}
	.refresh-button:hover {
		background-color: #0069d9;
	}
</style>
{% endblock %} {% block content %}
<div class="container py-4 analytics-container">
	<div class="row">
		<div class="col-12">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h1 class="mb-0">Analytics Dashboard</h1>
				<button id="refreshData" class="refresh-button"><i class="fas fa-sync-alt"></i> Refresh Data</button>
			</div>

			<div class="card-grid">
				<div class="stats-card">
					<div class="stats-header">
						<h3>Total Page Views</h3>
						<i class="fas fa-eye"></i>
					</div>
					<div class="stats-value" id="totalPageViews">--</div>
					<div class="stats-label">across all pages</div>
				</div>

				<div class="stats-card">
					<div class="stats-header">
						<h3>Users</h3>
						<i class="fas fa-users"></i>
					</div>
					<div class="stats-value" id="uniqueUsers">--</div>
					<div class="stats-label">unique users</div>
				</div>

				<div class="stats-card">
					<div class="stats-header">
						<h3>Searches</h3>
						<i class="fas fa-search"></i>
					</div>
					<div class="stats-value" id="totalSearches">--</div>
					<div class="stats-label">search queries</div>
				</div>

				<div class="stats-card">
					<div class="stats-header">
						<h3>Uploads</h3>
						<i class="fas fa-upload"></i>
					</div>
					<div class="stats-value" id="totalUploads">--</div>
					<div class="stats-label">files uploaded</div>
				</div>
			</div>

			<div class="row mb-4">
				<div class="col-md-6">
					<div class="stats-card">
						<div class="stats-header">
							<h3>Page Views by Page</h3>
						</div>
						<div class="chart-container">
							<canvas id="pageViewsChart"></canvas>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="stats-card">
						<div class="stats-header">
							<h3>Search Terms</h3>
						</div>
						<div class="chart-container">
							<canvas id="searchTermsChart"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div class="stats-card">
				<div class="stats-header">
					<h3>Recent Searches</h3>
				</div>
				<div class="table-container">
					<table class="analytics-table" id="searchesTable">
						<thead>
							<tr>
								<th>Time</th>
								<th>User</th>
								<th>Course</th>
								<th>Professor</th>
								<th>File Type</th>
								<th>Results</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td colspan="6" class="text-center">Loading data...</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div class="stats-card">
				<div class="stats-header">
					<h3>Recent Uploads</h3>
				</div>
				<div class="table-container">
					<table class="analytics-table" id="uploadsTable">
						<thead>
							<tr>
								<th>Time</th>
								<th>User</th>
								<th>Course</th>
								<th>Professor</th>
								<th>File Type</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td colspan="5" class="text-center">Loading data...</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block additional_scripts %}
<script>
	// Charts and data
	let pageViewsChart, searchTermsChart;

	// Load data on page load
	document.addEventListener("DOMContentLoaded", function () {
		loadAnalyticsData();

		// Setup refresh button
		document.getElementById("refreshData").addEventListener("click", loadAnalyticsData);
	});

	// Load analytics data from API
	function loadAnalyticsData() {
		fetch("/analytics/api/analytics/summary")
			.then((response) => {
				if (!response.ok) {
					throw new Error("Unauthorized");
				}
				return response.json();
			})
			.then((data) => {
				updateDashboard(data);
			})
			.catch((error) => {
				console.error("Error fetching analytics data:", error);
				if (error.message === "Unauthorized") {
					alert("You are not authorized to view this page. Please log in as an admin.");
					window.location.href = "{{ url_for('admin.admin_login') }}";
				}
			});
	}

	// Update dashboard with data
	function updateDashboard(data) {
		// Update summary numbers
		const totalViews = Object.values(data.page_views).reduce((sum, current) => sum + current, 0);
		document.getElementById("totalPageViews").textContent = totalViews;
		document.getElementById("uniqueUsers").textContent = data.user_count;
		document.getElementById("totalSearches").textContent = data.search_count;
		document.getElementById("totalUploads").textContent = data.upload_count;

		// Update charts
		updatePageViewsChart(data.page_views);
		// Other chart updates would go here

		// Update tables (simplified implementation)
		// In a real implementation, you would populate these tables with actual data
		document.getElementById("searchesTable").querySelector("tbody").innerHTML =
			'<tr><td colspan="6" class="text-center">Data loaded. Full implementation would show actual searches.</td></tr>';
		document.getElementById("uploadsTable").querySelector("tbody").innerHTML =
			'<tr><td colspan="5" class="text-center">Data loaded. Full implementation would show actual uploads.</td></tr>';
	}

	// Update page views chart
	function updatePageViewsChart(pageViews) {
		const ctx = document.getElementById("pageViewsChart").getContext("2d");

		// Destroy previous chart if it exists
		if (pageViewsChart) {
			pageViewsChart.destroy();
		}

		// Create labels and data from page views
		const labels = [];
		const data = [];

		for (const [page, count] of Object.entries(pageViews)) {
			// Format page path for display
			let label = page;
			if (page === "/") {
				label = "Home";
			} else {
				label = page.replace(/^\//, "").replace(/\/$/, "");
				// Capitalize first letter
				label = label.charAt(0).toUpperCase() + label.slice(1);
			}

			labels.push(label);
			data.push(count);
		}

		// Create new chart
		pageViewsChart = new Chart(ctx, {
			type: "bar",
			data: {
				labels: labels,
				datasets: [
					{
						label: "Page Views",
						data: data,
						backgroundColor: "rgba(54, 162, 235, 0.5)",
						borderColor: "rgba(54, 162, 235, 1)",
						borderWidth: 1,
					},
				],
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				scales: {
					y: {
						beginAtZero: true,
						ticks: {
							precision: 0,
						},
					},
				},
			},
		});
	}
</script>
{% endblock %}
